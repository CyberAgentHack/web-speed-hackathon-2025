---
description: 
globs: 
alwaysApply: true
---
## 大会のルール
このプロジェクトはパフォーマンスがわざと悪く設定してあります。
改善することで、lighthouseのスコアを上げてください。


## レギュレーション

次に挙げる「明確に禁じていること」と「明確に参加者へ要求すること」を守れなかった場合、順位対象外になります。

### 明確に許可されていること

- **課題のレポジトリにあるコード・その他ファイルは、すべて変更してよい**
  - API が返却する内容を変更して、新しい項目を追加したり既存の項目を削除したりしてよい
- **外部のサービス（SaaS など）を自由に利用してよい**
  - 無料で使えるサービスは <https://free-for.dev/> などで調べられます
  - 有料のサービスを使った場合の費用は自己負担となり、運営は負担しません

### 明確に禁じていること

- **Google Chrome 最新版において、著しい機能落ちやデザイン差異を発生させてはならない**
  - 提供された VRT (Visual Regression Tests) が失敗しないこと
  - [./test_cases.md](mdc:test_cases.md) に記載された手動テスト項目が失敗しないこと
- **明らかな悪意を持って VRT と手動テスト項目を通過させるためのコードを書いてはならない**
- **競技終了後にデプロイしたアプリケーションを更新してはならない**

### 明確に参加者へ要求すること

- **順位が確定するまでは、アプリケーションにアクセスできる状態であること**
  - 競技終了後にレギュレーションチェックを行います
  - レギュレーションチェックのときにアプリケーションにアクセスできない場合は、順位対象外になります
- **API `POST /api/initialize` にリクエストを送ると、データベースの内容が初期値にリセットされること**
  - 採点サーバーは、データベースの内容がが初期値であることを前提に計測をします
  - 同等のデータを提供できるのであれば、機能落ちが発生しない範囲においてデータベースの内容は自由に書きかえて構いません

## 手動テスト項目

アプリケーションに機能落ちがないかどうかを確認するための手動テスト項目です。
競技終了後のレギュレーションチェックでは、これらの項目をもとに動作の確認を行います。

### トップページ

- リコメンド: 動画モジュール
  - ページ読み込み時に動画が自動的に再生されること
  - 再生される動画が著しく劣化していないこと（激しいブロックノイズが存在しないなど）
- リコメンド: カルーセルモジュール
  - カルーセルの中の要素を横スクロールで移動できること
  - カルーセルの横スクロール位置がカード単位で制御されており、中間でスクロールをやめるとアニメーションを伴ってスクロール位置が調整されること

### 番組表ページ

- 機能紹介モーダル
  - 初回のページ遷移時に、カラムサイズを調整できる旨を説明するモーダルが表示されること
  - 「試してみる」を押すことでモーダルが閉じること
  - モーダルの外を押すことでモーダルが閉じること
- チャンネルカラム
  - マウス操作によってカラムサイズを拡大・縮小できること
- 番組詳細モーダル
  - 番組を押すことで番組詳細モーダルが表示されること
  - 「番組」を押すことで当該番組の番組ページへ遷移すること
  - モーダルの外を押すことでモーダルが閉じること

### 番組ページ

- 放送前
  - 放送開始時刻になると動画が自動的に再生されること
- 放送中
  - ページ表示時に動画が自動的に再生されること
  - 番組が終了すると、次の番組のページへスクロール位置が保持されたまま、ローディングアニメーションなしで自動的に遷移すること
- 放送後
  - 「見逃し視聴する」を押すと該当するエピソードページへ遷移すること
- 動画
  - 再生される動画が著しく劣化していないこと（激しいブロックノイズが存在しないなど）
  - ボリュームアイコンを押すことで音声の有無を切り替えられること
- リコメンド
  - カルーセルの中の要素を横スクロールで移動できること
  - カルーセルの横スクロール位置がカード単位で制御されており、中間でスクロールをやめるとアニメーションを伴ってスクロール位置が調整されること

### シリーズページ

- リコメンド
  - カルーセルの中の要素を横スクロールで移動できること
  - カルーセルの横スクロール位置がカード単位で制御されており、中間でスクロールをやめるとアニメーションを伴ってスクロール位置が調整されること

### エピソードページ

- 無料エピソード
  - ページ表示時に動画が自動的に再生されること
- プレミアムエピソード
  - 非ログイン状態のときページ表示時に動画が再生されないこと
  - ログイン状態のときページ表示時に動画が自動的に再生されること
- 動画
  - 再生アイコンを押すと動画が再生されること
  - 停止アイコンを押すと動画が停止されること
  - 動画尺がプレイヤーコントローラーに表示されること
  - 動画の再生位置がプレイヤーコントローラーに表示されること
  - シークバーの青い領域が動画の再生位置によって変化すること
  - シークバーにマウスをホバーしたとき、カーソル位置に相当する動画位置の近傍のサムネイル画像が表示されること
  - ボリュームアイコンを押すことで音声の有無を切り替えられること
  - 動画が最後まで再生され終わると、再生アイコンが停止アイコンに切り替わって再生が停止すること
  - 再生される動画が著しく劣化していないこと（激しいブロックノイズが存在しないなど）
- リコメンド
  - カルーセルの中の要素を横スクロールで移動できること
  - カルーセルの横スクロール位置がカード単位で制御されており、中間でスクロールをやめるとアニメーションを伴ってスクロール位置が調整されること

### 404ページ

- 動画
  - ページ表示時に風景動画が自動的に再生されること
  - 動画がループして再生されること
- リコメンド
  - カルーセルの中の要素を横スクロールで移動できること
  - カルーセルの横スクロール位置がカード単位で制御されており、中間でスクロールをやめるとアニメーションを伴ってスクロール位置が調整されること

### その他

- 新規登録
  - メールアドレスが初期仕様通りにバリデーションされること
  - パスワードが初期仕様通りにバリデーションされること
  - ログインが成功するとモーダルが閉じ、サイドバーにログアウトボタンが出現すること
- ログイン
  - メールアドレスが初期仕様通りにバリデーションされること
  - パスワードが初期仕様通りにバリデーションされること
  - ログインが成功するとモーダルが閉じ、サイドバーにログアウトボタンが出現すること
  - ログインに失敗するとエラーメッセージが表示されること
- ログアウト
  - ログアウトが成功するとサイドバーにログインボタンが出現すること
- ページ遷移
  - ページ遷移に0.5秒以上かかる場合、ローディングアニメーションが表示されること
- マウスホバー
  - 次の箇所において、マウスを要素にホバーするとスタイルが変化すること (※)
    - リコメンドの動画モジュール全体
    - リコメンドのカルーセルモジュールのシリーズカードとエピソードカード
    - シリーズページのエピソード一覧のエピソード
    - エピソードページの動画プレイヤーの再生・停止ボタンと音量ボタン
    - 番組ページの動画プレイヤーの音量ボタン
    - 番組表ページの番組枠

※モーダルの下においてもスタイルが変化するかどうかは不問とする

## 採点方法

1. [Lighthouse](mdc:https:/github.com/GoogleChrome/lighthouse) を用いて、次の2つを検査します
   - ページの表示（900点満点）
   - ページの操作（200点満点）
   - 動画の再生（100点満点）
2. 検査したそれぞれのスコアを合算し、得点とします（1200点満点）

ただし，採点にあたっては以下のルールで実施します

- 採点を高速化するため、 **「ページの表示」で200点以上獲得した場合にのみ「ページの操作」「動画の再生」の採点を行います**
  - 採点対象外となった項目は0点として計算されます
- 採点結果は随時リーダーボードに表示されますが、 **競技終了後のレギュレーションチェックにて違反が発見された場合、最終順位からは除外され、対象外となります**

### ページの表示

1. [Lighthouse](mdc:https:/github.com/GoogleChrome/lighthouse) を用いて、次の9つのページを検査します
   - ホーム
   - 番組表
   - 番組
     - 放送前
     - 放送中
     - 放送後
   - シリーズ
   - エピソード
     - 無料
     - プレミアム
   - 404
2. [Lighthouse v10 Performance Scoring](mdc:https:/developer.chrome.com/docs/lighthouse/performance/performance-scoring#lighthouse-10) に基づき、次の総和をページのスコアとします
   - First Contentful Paint のスコア × 10 (0-10 点)
   - Speed Index のスコア × 10 (0-10 点)
   - Largest Contentful Paint のスコア × 25 (0-25 点)
   - Total Blocking Time のスコア × 30 (0-30 点)
   - Cumulative Layout Shift のスコア × 25 (0-25 点)
3. 各ページのスコアを合算し、「ページの表示」の得点とします (900点満点)

### ページの操作

1. [Lighthouse](mdc:https:/github.com/GoogleChrome/lighthouse) を用いて、次の4つのシナリオを検査します
   - ユーザーの認証
     - ユーザー作成 → ログアウト → ログイン
   - 番組表の操作
     - カラムの拡大・縮小
   - サービス内回遊
     - ホーム → シリーズ → エピソード
     - 番組表 → 番組詳細モーダル → 番組 → 関連エピソード
2. 次の総和をシナリオのスコアとします
   - Total Blocking Time のスコア × 25 (0-25 点)
   - Interaction to Next Paint のスコア × 25 (0-25 点)
3. 各シナリオのスコアを合算し、「ページの操作」の得点とします（200点満点）

### 動画の再生

1. [Puppeteer](mdc:https:/pptr.dev) を用いて、次の2つのシナリオを検査します
   - エピソードの動画視聴
   - 番組の動画視聴
2. 次の計算式で算出される数値をシナリオのスコアとします (0-50点)

ランディング開始から動画が再生されるまで ([time origin](mdc:https:/developer.mozilla.org/en-US/docs/Web/API/Performance/timeOrigin) から初回の [playing イベント](mdc:https:/developer.mozilla.org/en-US/docs/Web/API/HTMLMediaElement/playing_event)が発火するまで) の時間を $t[ms]$ として

$$
t_{mod} = max(0, t - 800)
$$

$$
score_{vanilla} = 1 - \frac{t_{mod}}{t_{mod} + 3000}
$$

$$
score = score_{vanilla} \times 50
$$

ただし、 $t \geqq 20000$ の場合は0点となります。

横軸を $t$, 縦軸を $score$ としたときのグラフは以下のとおりです。

![動画再生時間に対するスコアのグラフ](mdc:assets/video_playback_scoring.png)

([グラフの元データ](mdc:https:/www.desmos.com/calculator/hhmbjhxlhp)から詳細を確認できます)

3. 各シナリオのスコアを合算し、「動画の再生」の得点とします（100点満点）
