# Web Speed Hackathon 2025 - Bad To Do リスト

このドキュメントは、アプリケーションのパフォーマンス改善が必要な箇所をリストアップし、詳細な調査と改善方針を示すものです。

## 1. バンドル最適化

### 1.1 Code Splitting

- [x] Dynamic Importの実装状況の確認
  - `workspaces/client/src/pages/`の各ページコンポーネント
    - ✅ `lazy()`を使用したコンポーネントの遅延ローディングは実装済み
    - ❌ `p-min-delay`により強制的な1000msの遅延が追加されている
    - ❌ プリフェッチ戦略の最適化が必要
  - `workspaces/client/src/features/`の大規模コンポーネント
    - ❌ 機能コンポーネントレベルでの分割が未実装
- [ ] ルートベースの遅延ローディングの実装状況
  - ✅ React Routerのlazyローディングは実装済み
  - ❌ Suspenseの活用が不十分

### 1.2 ポリフィル最適化

- [x] `setups/polyfills.ts`の内容確認
  - ❌ `core-js`全体をインポートしており、必要なポリフィルのみに絞り込めていない
  - ❌ `view-transitions-polyfill`の必要性の検証が必要
  - ❌ `setimmediate`の必要性の検証が必要
  - 改善案:
    - `core-js`の必要な機能のみをインポート
    - ブラウザターゲットに基づいてポリフィルを条件付きでロード
    - 不要なポリフィルの削除

### 1.3 Tree Shaking

- [ ] 未使用コードの削除状況
- [ ] サードパーティライブラリの最適化

## 2. レンダリング最適化

### 2.1 コンポーネントレンダリング

- [x] メモ化の実装状況確認
  - ❌ `React.memo`が使用されていない
    - 特にタイムテーブルの各コンポーネント（Program, ChannelTitle等）で必要
  - ❌ `useMemo`/`useCallback`の適用が不足
    - プログラムリストの変換処理
    - イベントハンドラ
- [x] 不要な再レンダリングの特定
  - ❌ タイムテーブルページで全てのプログラムを一度にレンダリング
  - ❌ チャンネルリストとプログラムリストの分離が不十分

### 2.2 リスト仮想化

- [x] 以下のコンポーネントでの仮想化実装確認：
  - タイムテーブル表示
    - ❌ 仮想化が未実装
    - ❌ 全ての番組を一度にレンダリング
    - ❌ スクロール時のパフォーマンス問題
  - エピソードリスト
    - ❌ 仮想化の実装状況未確認
  - チャンネルリスト
    - ❌ 仮想化の実装状況未確認
      改善案:
  - `react-window`または`react-virtualized`の導入
  - 表示範囲外のコンテンツの遅延ローディング
  - スクロール位置に基づく動的レンダリング

### 2.3 レイアウト最適化

- [ ] レイアウトシフトの確認
- [ ] CSS最適化（UnoCSS）の確認

## 3. データ取得最適化

### 3.1 APIリクエスト

- [x] キャッシュ戦略の確認
  - ❌ APIレスポンスのキャッシュが未実装
  - ❌ キャッシュの有効期限設定が不在
  - ❌ 重複リクエストの防止機能が不足
- [x] プリフェッチの実装状況
  - ✅ ページレベルのプリフェッチは実装済み
  - ❌ インタラクションベースのプリフェッチが未実装
  - ❌ 予測的プリフェッチが未実装
- [x] エラーハンドリングの実装
  - ❌ エラー状態の管理が不十分
  - ❌ リトライ機能が未実装
  - ❌ ユーザーへのエラー表示が最適化されていない

改善案:

- SWRやReact Queryの導入
- キャッシュ戦略の実装
  - ストール時間の設定
  - 再検証ポリシーの設定
- エラーハンドリングの強化
  - リトライロジックの実装
  - エラーバウンダリの導入

### 3.2 状態管理

- [x] Zustandストアの分割状況
  - ✅ 機能ごとのストアスライスは実装済み
  - ❌ 状態の正規化が不十分
  - ❌ 重複データの排除が不十分
- [x] 状態更新の最適化
  - ❌ Immerの使用が部分的
  - ❌ 不要な状態更新が発生
  - ❌ バッチ更新の最適化が不足
- [x] メモリリークの確認
  - ❌ 古いデータの破棄ロジックが未実装
  - ❌ キャッシュサイズの制限が未設定
  - ❌ コンポーネントのクリーンアップが不十分

改善案:

- 状態の正規化
  - エンティティの一元管理
  - 参照関係の最適化
- 更新ロジックの改善
  - Immerの一貫した使用
  - バッチ更新の実装
- メモリ管理の強化
  - LRUキャッシュの導入
  - クリーンアップロジックの実装

## 4. メディア最適化

### 4.1 画像最適化

- [x] 遅延ローディングの実装状況
  - ❌ `loading="lazy"`属性が未使用
  - ❌ Intersection Observerを使用した遅延ローディングが未実装
  - ❌ プレースホルダー画像の最適化が不足
- [x] 適切な画像フォーマットの使用
  - ❌ WebPやAVIFなどの最新フォーマットが未使用
  - ❌ 画像のフォーマット選択が最適化されていない
  - ❌ 画像の品質設定が最適化されていない
- [x] 画像サイズの最適化
  - ❌ レスポンシブ画像の実装が不十分
  - ❌ `srcset`と`sizes`属性が未使用
  - ❌ 画像のリサイズ処理が最適化されていない

改善案:

- 画像の遅延ローディング実装
  - `loading="lazy"`属性の追加
  - Intersection Observerの活用
- 最新フォーマットの導入
  - WebP/AVIFの生成と配信
  - フォールバック対応
- レスポンシブ画像の実装
  - `srcset`と`sizes`属性の追加
  - 適切なブレークポイントの設定

### 4.2 動画プレーヤー

- [x] プレーヤーの初期化タイミング
  - ❌ 動的インポートの遅延が過剰（1000ms）
  - ❌ プレーヤーの事前初期化が未実装
  - ❌ 不要なプレーヤーインスタンスの破棄が不十分
- [x] ストリーミング設定の最適化
  - ❌ アダプティブビットレートの設定が不十分
  - ❌ バッファリング戦略の最適化が必要
  - ❌ プリロード設定の最適化が必要
- [x] チャンクサイズと品質設定
  - ❌ セグメントサイズの最適化が必要
  - ❌ 品質切り替えの閾値設定が不十分
  - ❌ 初期品質設定の最適化が必要

改善案:

- プレーヤー初期化の最適化
  - 遅延時間の調整
  - プレーヤーのプール管理
- ストリーミング設定の改善
  - アダプティブビットレートの調整
  - バッファリング戦略の最適化
- 品質管理の強化
  - セグメントサイズの最適化
  - 品質切り替えロジックの改善

## 5. パフォーマンス計測

### 5.1 メトリクス

- [ ] Core Web Vitalsの計測
  - FCP (First Contentful Paint)
  - LCP (Largest Contentful Paint)
  - CLS (Cumulative Layout Shift)
  - FID (First Input Delay)

### 5.2 モニタリング

- [ ] パフォーマンスモニタリングの実装
- [ ] エラー追跡の実装

## 調査手順

1. Lighthouseレポートの分析
2. Network タブでのリクエスト分析
3. Performance タブでのボトルネック特定
4. メモリリークのプロファイリング
5. バンドルサイズの分析

## 優先度の高い改善項目

1. ポリフィルの最適化
   - 必要最小限のポリフィルのみをインポート
   - 条件付きローディングの実装
2. メディア最適化
   - 画像の遅延ローディングと最適化
   - 動画プレーヤーの初期化と設定の改善
3. データ取得の最適化
   - キャッシュ戦略の実装
   - 状態管理の改善
   - エラーハンドリングの強化
4. レンダリング最適化
   - タイムテーブルの仮想化実装
   - メモ化の適用
   - 不要な再レンダリングの削減
5. Code Splittingの改善
   - `p-min-delay`の削除
   - 機能コンポーネントレベルでの分割実装

各項目の調査結果と具体的な改善案は、調査完了後に追記していきます。
