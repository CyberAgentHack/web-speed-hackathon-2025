# アクティブコンテキスト - AREMA

## 現在の焦点

現在の焦点は、AREMAアプリケーションのパフォーマンス問題を特定し、最適化計画を立てることです。特に以下の点に注目しています：

1. 大きなHTMLファイルの原因分析と修正
2. 認証ダイアログの問題解決
3. 動画再生の最適化
4. 画像最適化戦略の実装

## 最近の変更

- プロジェクト文書でmemory-bankを初期化
- 開発環境のセットアップが完了（pnpm run startで動作確認）
- 初期パフォーマンス調査を実施、具体的な問題点を特定
- Playwrightテストで複数の失敗を確認、タイムアウトが主要な問題

## 現在の状態

- プロジェクトはクローンされ、ローカル環境で実行されている
- memory-bankは基本ドキュメントで初期化された
- 開発環境のセットアップが完了し、アプリケーションが起動された
- 初期パフォーマンス調査により主要な問題点を特定
- アプリケーションは起動していますが、初期パフォーマンスに重大な問題があります
- HTMLのサイズが約55MBと非常に大きく、ブラウザの読み込みが遅延
- Lighthouseによる評価で「NO_FCP」エラーが発生（First Contentful Paintが発生しない）
- ログイン/認証システムに問題があり、テストが失敗する
- 動画再生機能に問題があり、テストがタイムアウトする

## パフォーマンス問題の詳細

1. **HTMLファイルサイズの問題**:

   - メインのHTMLファイルが約55MBと非常に大きい
   - 全ての画像ファイルがプリロードタグとして直接HTMLに埋め込まれている
   - 原因コード: `workspaces/server/src/ssr.tsx`内のpreloadタグ生成部分
   - 現在の実装場所が見つかっていないが、コードは以下のようなもの:

     ```typescript
     const imagePaths = [
       getFilePaths('public/images', rootDir),
       getFilePaths('public/animations', rootDir),
       getFilePaths('public/logos', rootDir),
     ].flat();

     reply.type('text/html').send(/* html */ `
       ...
       ${imagePaths.map((imagePath) => `<link as="image" href="${imagePath}" rel="preload" />`).join('\n')}
       ...
     `);
     ```

2. **認証機能の問題**:

   - ログインダイアログが適切に閉じられない
   - テストでは`await expect(signInDialog).not.toBeVisible();`で失敗
   - ダイアログがログイン処理後も表示されたままになっている

3. **動画再生の問題**:

   - `waitForVideoToLoad`関数がタイムアウトする
   - 動画のメタデータが適切に読み込まれない
   - 複数のプレーヤー実装（HLS.js, Shaka, Video.js）があるが最適化が必要

4. **画像ファイルの状況**:
   - public/images: 38ファイル (合計34MB)
   - public/animations: 2ファイル (合計12MB)
   - public/logos: 13ファイル (合計35MB)
   - 全てのファイルが無条件でプリロードされている

## パフォーマンス改善計画

1. **優先度：最高 - HTMLサイズの削減**

   - SSRコードの修正：不要なプリロードを削除
   - ページごとに必要な画像のみをプリロードするロジックに変更
   - サーバーサイドの`ssr.tsx`を特定して修正

2. **優先度：高 - 認証システムの修正**

   - ログインダイアログが正しく閉じるように修正
   - authService内のフェッチ処理とストア更新の最適化
   - ダイアログコンポーネントの表示/非表示ロジックの見直し

3. **優先度：高 - 動画再生の最適化**

   - 動画プレーヤーの実装を最適化
   - 動画メタデータの読み込み方法を改善
   - 必要なときだけ動画を読み込む遅延読み込み戦略の実装

4. **優先度：中 - 画像の最適化**

   - 画像の遅延読み込み（Lazy Loading）実装
   - 画像フォーマットの最適化（WebPへの変換）
   - 表示サイズに応じた異なる解像度の画像提供

5. **優先度：中 - Webpackの最適化**
   - バンドルサイズの削減
   - コード分割の導入
   - キャッシュ戦略の改善

## 次のステップ

1. SSRコードを特定して修正し、プリロードを最適化
2. 認証ダイアログの問題を修正
3. 動画再生機能を改善
4. 画像の最適化を実装
5. Webpackの設定を最適化

## アクティブな決定

- HTMLサイズの削減が最優先タスク
- 不必要なプリロードを削除し、必要な画像のみをプリロードする方針
- 画像の遅延読み込み（Lazy Loading）を実装する方針
- 画像フォーマットの最適化（WebPなど）を検討
- ページごとに必要なリソースのみをロードする戦略を採用
